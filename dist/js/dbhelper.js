"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){a=!0,o=t}finally{try{!r&&u.return&&u.return()}finally{if(a)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var DBPromise=void 0;function formatSingleRestaurantData(t){return Object.assign({},t,{photograph:t.photograph?t.photograph+".jpg":t.id+".jpg"})}function formatRestaurantsData(t){return t.map(formatSingleRestaurantData)}!function(){var t=idb.open("restuarant_app_db",4,function(t){switch(t.oldVersion){case 0:t.createObjectStore("keyval").put("value is value","key");case 1:t.createObjectStore("people",{keyPath:"name"});case 2:t.transaction.objectStore("people").createIndex("animal","favoriteAnimal");case 3:t.transaction.objectStore("people").createIndex("age","age")}});t.then(function(t){var e=t.transaction("people","readwrite"),n=e.objectStore("people");return n.put({name:"Sam Munoz",age:25,favoriteAnimal:"dog"}),n.put({name:"Wam ok",age:34,favoriteAnimal:"cat"}),n.put({name:"Kim Bad",age:35,favoriteAnimal:"dog"}),n.put({name:"Jam Good",age:21,favoriteAnimal:"dog"}),e.complete}),t.then(function(t){return t.transaction("people").objectStore("people").index("animal").getAll("dog")}),t.then(function(t){return t.transaction("people").objectStore("people").index("age").openCursor()}).then(function(t){if(t)return t.advance(2)}).then(function t(e){if(e)return e.continue().then(t)}),t.then(function(t){return t.transaction("keyval").objectStore("keyval").get("key")}),t.then(function(t){var e=t.transaction("keyval","readwrite");return e.objectStore("keyval").put("barValue","fooKey"),e.complete}),DBPromise=idb.open("restaurant-app",3,function(t){switch(t.oldVersion){case 0:var e=t.createObjectStore("restaurants",{keyPath:"id"});e.createIndex("by-name","name");case 1:t.createObjectStore("cuisines"),t.createObjectStore("neighborhoods");case 2:t.createObjectStore("detail",{keyPath:"id"})}})}();var DBHelper=function(){function c(){_classCallCheck(this,c),this.restaurants=[],this.neighborhoods=[],this.cuisines=[],this.details={}}return _createClass(c,null,[{key:"setLocalData",value:function(t){this.restaurants=t}},{key:"fetchRestaurantsFromCache",value:function(e){var n=this;return DBPromise.then(function(t){if(!(!t||n.restaurants&&n.restaurants.length))return t.transaction("restaurants").objectStore("restaurants").index("by-name").getAll().then(function(t){return e(null,t)}).catch(function(t){return e(t,null)})})}},{key:"fetchNeighborhoodsFromCache",value:function(e){var n=this;return DBPromise.then(function(t){if(!(!t||n.resneighborhoodstaurants&&n.neighborhoods.length))return t.transaction("neighborhoods").objectStore("neighborhoods").getAll().then(function(t){return e(null,t)}).catch(function(t){return e(t,null)})})}},{key:"fetchCuisinesFromCache",value:function(e){var n=this;return DBPromise.then(function(t){if(!(!t||n.cuisines&&n.cuisines.length))return t.transaction("cuisines").objectStore("cuisines").getAll().then(function(t){return e(null,t)}).catch(function(t){return e(t,null)})})}},{key:"fetchRestaurants",value:function(e){if(this.restaurants&&this.restaurants.length)return this.restaurants;fetch(c.DATABASE_URL).then(function(t){return t.json()}).then(formatRestaurantsData).then(function(r){return DBPromise.then(function(t){var e=t.transaction("restaurants","readwrite"),n=e.objectStore("restaurants");return r&&r.forEach(function(t){return n.put(t)}),e.complete}),r}).then(function(t){return e(null,t)}).then(function(t){return c.setLocalData(t)}).catch(function(t){return e(t,null)})}},{key:"fetchRestaurantByIdFromCache",value:function(e,n){var r=this;return DBPromise.then(function(t){if(!(!t||r.details&&r.details[e]))return t.transaction("detail").objectStore("detail").get(Number(e)).then(function(t){console.log("data",t),n(null,t)}).catch(function(t){return n(t,null)})})}},{key:"fetchRestaurantById",value:function(t,e){var r=this;fetch(c.DATABASE_URL+"/"+t).then(function(t){return t.json()}).then(formatSingleRestaurantData).then(function(n){return DBPromise.then(function(t){var e=t.transaction("detail","readwrite");return e.objectStore("detail").put(n),e.complete}),r.details=Object.assign({},r.details,_defineProperty({},t,n)),n}).then(function(t){t?e(null,t):e("Restaurant does not exist",null)}).catch(function(t){return e(t,null)})}},{key:"fetchRestaurantByCuisine",value:function(r,a){c.fetchRestaurants(function(t,e){if(t)a(t,null);else{var n=e.filter(function(t){return t.cuisine_type==r});a(null,n)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,a){c.fetchRestaurants(function(t,e){if(t)a(t,null);else{var n=e.filter(function(t){return t.neighborhood==r});a(null,n)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,a,o){c.fetchRestaurants(function(t,e){if(t)o(t,null);else{var n=e;"all"!=r&&(n=n.filter(function(t){return t.cuisine_type==r})),"all"!=a&&(n=n.filter(function(t){return t.neighborhood==a})),o(null,n)}})}},{key:"fetchNeighborhoods",value:function(a){c.fetchRestaurants(function(t,n){if(t)a(t,null);else{var r=n.map(function(t,e){return n[e].neighborhood}),e=r.filter(function(t,e){return r.indexOf(t)==e});DBPromise.then(function(t){var n=t.transaction("neighborhoods","readwrite").objectStore("neighborhoods");e&&e.forEach(function(t,e){return n.put(t,e)})}),a(null,e)}})}},{key:"fetchCuisines",value:function(a){c.fetchRestaurants(function(t,n){if(t)a(t,null);else{var r=n.map(function(t,e){return n[e].cuisine_type}),e=r.filter(function(t,e){return r.indexOf(t)==e});DBPromise.then(function(t){var n=t.transaction("cuisines","readwrite").objectStore("cuisines");e&&e.forEach(function(t,e){return n.put(t,e)})}),a(null,e)}})}},{key:"urlForRestaurant",value:function(t){return"./restaurant.html?id="+t.id}},{key:"imageUrlForRestaurant",value:function(t,e){return"/img/"+t+"-320_small."+e}},{key:"imageSrcset",value:function(t){var e=t.photograph.split("."),n=_slicedToArray(e,2),r=n[0],a=n[1];return"/img/"+r+"-320_small."+a+" 400w, /img/"+r+"-640_medium."+a+" 640w, /img/"+r+"-800_large."+a+" 800w "}},{key:"mapMarkerForRestaurant",value:function(t,e){return new google.maps.Marker({position:t.latlng,title:t.name,url:c.urlForRestaurant(t),map:e,animation:google.maps.Animation.DROP})}},{key:"getSourcesForRestaurant",value:function(t){var e=t.photograph.split("."),n=_slicedToArray(e,2),r=n[0],a=n[1],o=document.createElement("SOURCE");o.setAttribute("data-srcset",c.imageUrlForRestaurant(r,a));var i=document.createElement("SOURCE");i.setAttribute("data-srcset",c.imageUrlForRestaurant(r,"webp")),i.setAttribute("type","image/webp");var u=document.createElement("img");return u.setAttribute("data-srcset",c.imageUrlForRestaurant(r,a)),[i,o,u]}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}}]),c}();
//# sourceMappingURL=dbhelper.js.map
